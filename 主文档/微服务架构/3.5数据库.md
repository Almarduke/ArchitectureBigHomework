### 3.5 迭代五
<br/>
<br/>
#### 3.5.1 需求信息
<br/>
同迭代一
<br/>
#### 3.5.2 分解的系统组件
<br/>
选择系统的数据存储模块进行分解，数据存储模块主要承担职责如下：
<br/>
<b>· </b>存储用户信息、电影信息、评论信息、订单信息、交易数据等<br/>
<b>· </b>存储电影海报、用户头像、电影PV等静态资源<br/>
<b>· </b>对外提供统一访问接口<br/>
<b>· </b>内部监控各存储单元（主机）的工作情况<br/>
<br/>
#### 3.5.3 组件负责的ASRs

| 架构驱动                                | 重要性   | 难易度   |
|-----------| -------- | --------| 
| 场景1：>100的用户同时购买同一场电影的票 | 高 | 高 |
| 场景6：数据库崩溃   | 高 | 高 |

<br/>

#### 3.5.4 为ASR进行设计

<br/>

**1.设计关注点**

静态资源：电影海报、用户头像、电影PV<br/>
存储单元：存储数据的主机<br/>

| 质量属性 | 设计关注点 | 子关注点 |
| ---------- | -------------| -----------|
|  可靠性  | 数据备份 | 数据库备份 |
||| 文件系统备份 |
| 性能 | 静态资源存储 | 图片存储 |
||| 文字存储 |
||| 视频存储 |
| 可移植性 | 对外接口实现 | 数据库操作 |
| 可用性 | 错误处理 | 数据库宕机 |


 **2.关注点的候选模式**


<b>1)数据库备份<br/></b>
<blockquote>
i) 候选模式
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 成功概率 |
| ---------- | -------------| -----------|
|1| 实时备份 | 高 | 高 | 高 |
|2| 固定时间间隔备份 | 中 | 中 | 中 |

<blockquote>
ii) 选择的模式及理由<br/>
选择实时备份。<br/>
为了保证系统的可靠性，需要对数据库中的业务数据进行备份，以防数据库崩溃造成无法挽回的损失。由于业务数据直接关系到用户的财产安全，所以选择实时备份模式，虽然相对会消耗更多资源，但是用户的安全始终是第一位的。
</blockquote>
<br/>

<b>2)文件系统备份<br/></b>

<blockquote>
i) 候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 成功概率 |
| ---------- | -------------| -----------|
|1| 实时备份 | 高 | 高 | 高 |
|2| 固定时间间隔备份 | 中 | 中 | 中 |

<blockquote>
ii)选择的模式及理由<br/>
选择固定时间间隔备份。<br/>
相对业务数据而言，访问静态资源所需的系统开销更大，但重要性较低。若采用实时备份，将会造成大量的不必要的系统开销。另一方面，即使文件系统崩溃，大多数情况下也可以通过磁盘恢复得到原有数据。
</blockquote>
<br/>
<b>3)图片存储<br/></b>
<blockquote>
i)候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 成本 |
| ---------- | -------------| -----------|
|1| 文件系统存储 | 中 | 低 | 低 |
|2| 图形数据库存储 | 低 | 中 | 高 |

<blockquote>
ii)选择的模式及理由<br/>
选择文件系统存储。<br/>
相较于极其稳定和成熟的文件系统存储技术，图形数据库技术尚不成熟，无法保证高可用和稳定性。系统需要存储大量电影图片海报等，所以采用文件系统数据库能够存储更多图片。
</blockquote>
<br/>

<b>4)大段文本存储<br/></b>
<blockquote>
i)候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 成本 |
| ---------- | -------------| -----------|
|1| 文件系统存储 | 中 | 低 | 低 |
|2| 数据库存储 | 低 | 中 | 高 |

<blockquote>
ii)选择的模式及理由<br/>
选择文件系统存储。<br/>
大段文本若存储在数据库中，因为各字段长短不一，会造成极大的资源浪费，同时会降低数据库访问性能，而使用文件系统存储则不会出现类似问题。
</blockquote>
<br/>

<b>5)视频存储<br/></b>
<blockquote>
i)候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 成本 |
| ---------- | -------------| -----------|
|1| 文件系统存储 | 中 | 低 | 低 |
|2| 数据库存储 | 低 | 中 | 高 |

<blockquote>
ii)选择的模式及理由<br/>
选择文件系统存储。<br/>
视频文件过大，而且没有合适的数据库可以存储视频文件。
</blockquote>
<br/>

<b>6)数据库操作<br/></b>
<blockquote>
i)候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 启动时间开销 |
| ---------- | -------------| -----------|
|1| 静态sql语句 | 低 | 低 | 低 |
|2| 动态生成sql | 低 | 中 | 高 |

<blockquote>

ii)选择的模式及理由<br/>
动态生成sql<br/>
数据库迁移时，静态的sql语言需要重写，开销较大，又因为数据库不需要频繁启动，所以启动成本可以不考虑在内。</blockquote>
<br/>

<b>7)数据库宕机<br/></b>
<blockquote>
i)候选模式<br/>
</blockquote>

| # | 模式名称 | 时间开销 | 资源开销 | 监控即时性 |
| ---------- | -------------| -----------|
|1| 固定时间间隔监控 | 低 | 低 | 低 |
|2| 请求无响应时报错 | 中 | 中 | 中 |
|2| 实时监控 | 高 | 高 | 高 |


<blockquote>
ii)选择的模式及理由<br/>
固定时间间隔监控<br/>
实时监控的成本巨大，然而当请求无响应时报错，故障实时排除的难度较大，所以选用固定时间间隔监控。
</blockquote>

**3.候选模式与对应ASR**<br/>

| 模式类型     | 选择的模式         | 架构驱动      |
| ------------ | ------------------ | ------------- |
| 数据库备份 | 数据备份 | 场景6 |
| 文件系统备份 | 固定时间间隔备份 | 场景6 |
| 图片存储 | 文件系统存储 | 场景1 |
| 大段文本存储 | 文件系统存储 | 场景1 |
| 视频存储 | 文件系统存储 | 场景1 |
| 数据库操作 | 动态生成sql | 场景1 |
| 数据库宕机 | 固定时间间隔监控 | 场景6 |
</br>
</br>
#### 3.5.5 架构视图
</br>
1. **C&C视图**
</br>
2. **Module视图**
</br>

#### 3.5.6 评估
</br>
本次设计使用ADD方法对数据存储模块进行分解、细化，在考虑各质量属性的同时，兼顾了系统的实际成本（数据库存储），并在系统性能、可伸缩性、可移植性、可靠性及可用性之间做了权衡，较好的兼顾了上述各质量属性。
</br>
